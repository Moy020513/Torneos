{% extends 'base.html' %}

{% block title %}{% if jugador %}Editar Jugador{% else %}Agregar Nuevo Jugador{% endif %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Encabezado -->
            <div class="card-header bg-primary text-white mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-user-plus"></i>
                    {% if jugador %}
                        Editar Información del Jugador
                    {% else %}
                        Registrar Nuevo Jugador
                    {% endif %}
                </h2>
            </div>

            <!-- Tarjeta del Formulario -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    
                    <!-- Información del jugador (si es edición) -->
                    {% if jugador %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <strong><i class="fas fa-info-circle"></i> Modo Edición</strong><br>
                        Modificando datos del jugador: <strong>{{ jugador.nombre }}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <!-- Formulario -->
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <!-- Mostrar errores generales del formulario -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong><i class="fas fa-exclamation-triangle"></i> Error en el formulario:</strong>
                            {% for error in form.non_field_errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}

                        <!-- Campos del formulario -->
                        <div class="form-container">
                            {% for field in form %}
                                    {% if field.name != 'equipo' and field.widget.input_type != 'hidden' %}
                                <div class="mb-3">
                                    <!-- Etiqueta -->
                                    <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                        {{ field.label }}
                                        {% if field.field.required %}
                                            <span class="text-danger">*</span>
                                        {% endif %}
                                    </label>

                                    <!-- Campo de entrada -->
                                    {% if field.widget.input_type == 'textarea' %}
                                        {{ field }}
                                    {% elif field.widget.input_type == 'file' %}
                                        <div class="input-group">
                                            {{ field }}
                                            <span class="input-group-text">
                                                <i class="fas fa-upload"></i>
                                            </span>
                                        </div>
                                        {% if field.help_text %}
                                            <small class="form-text text-muted d-block mt-2">
                                                {{ field.help_text|safe }}
                                            </small>
                                        {% endif %}
                                    {% else %}
                                        {{ field }}
                                        {% if field.help_text %}
                                            <small class="form-text text-muted d-block mt-2">
                                                {{ field.help_text|safe }}
                                            </small>
                                        {% endif %}
                                    {% endif %}

                                    <!-- Errores del campo -->
                                    {% if field.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in field.errors %}
                                                <i class="fas fa-times-circle"></i> {{ error }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Botones de acción -->
                        <div class="form-actions mt-5 pt-4 border-top">
                            <div class="row gap-2">
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-success btn-lg w-100">
                                        <i class="fas fa-save"></i>
                                        {% if jugador %}
                                            Actualizar Jugador
                                        {% else %}
                                            Guardar Jugador
                                        {% endif %}
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <a href="{% url 'capitan_panel' %}" class="btn btn-outline-secondary btn-lg w-100">
                                        <i class="fas fa-arrow-left"></i> Volver al Panel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Pie de página informativo -->
            <div class="mt-4 text-center text-muted">
                <small>
                    Los campos marcados con <span class="text-danger">*</span> son obligatorios.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Estilos personalizados -->
<style>
    .card-header {
        border-radius: 8px 8px 0 0;
        padding: 1.5rem;
    }

    .form-label {
        color: #333;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #ddd;
        padding: 0.6rem 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .form-control.is-invalid, .form-select.is-invalid {
        border-color: #dc3545;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-actions {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1.5rem;
        margin: 0 -1.5rem -1.5rem;
    }

    .input-group-text {
        border-radius: 6px;
    }
</style>
<!-- Flatpickr y Cropper.js -->
<link rel="stylesheet" href="/static/admin/css/flatpickr.min.css">
<link rel="stylesheet" href="/static/admin/css/cropper.min.css">
<script src="/static/admin/js/flatpickr.min.js"></script>
<script src="/static/admin/js/es.js"></script>
<script src="/static/admin/js/cropper.min.js"></script>
<script>
    // Flatpickr para fecha de nacimiento
    flatpickr("#id_fecha_nacimiento", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        yearRange: [1950, new Date().getFullYear()],
        defaultDate: "2000-01-01",
        locale: "es",
        allowInput: true,
    });

    // Cropper.js para foto
    const fotoInput = document.getElementById('id_foto');
    let cropperModal = null;
    let cropper = null;
    fotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                // Crear modal para cropper
                let modal = document.createElement('div');
                modal.id = 'cropper-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.8)';
                modal.style.zIndex = '9999';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.innerHTML = '<div style="background:#fff;padding:20px;border-radius:8px;max-width:90vw;max-height:90vh;overflow:auto;text-align:center;"><img id="cropper-image" style="max-width:400px;max-height:400px;"><br><button id="cropper-save" class="btn btn-success mt-3">Usar recorte</button> <button id="cropper-cancel" class="btn btn-secondary mt-3 ms-2">Cancelar</button></div>';
                document.body.appendChild(modal);
                cropperModal = modal;
                const cropperImage = document.getElementById('cropper-image');
                cropperImage.src = event.target.result;
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
                document.getElementById('cropper-save').onclick = function() {
                    cropper.getCroppedCanvas().toBlob(function(blob) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(new File([blob], file.name, {type: blob.type}));
                        fotoInput.files = dataTransfer.files;
                        cropper.destroy();
                        cropperModal.remove();
                    });
                };
                document.getElementById('cropper-cancel').onclick = function() {
                    cropper.destroy();
                    cropperModal.remove();
                };
            };
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}