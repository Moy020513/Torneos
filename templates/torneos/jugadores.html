{% extends 'torneos/base.html' %}
{% load custom_filters %}
{% block categoria_content %}
    <!-- Encabezado/nav heredados desde torneos/base.html -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="equipoFiltro" class="form-label" style="color: white;">Filtrar por equipo:</label>
            <select id="equipoFiltro" class="form-select">
                <option value="">Todos</option>
                {% for equipo in equipos %}
                    <option value="{{ equipo.id }}">{{ equipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="posicionFiltro" class="form-label" style="color: white;">Filtrar por posición:</label>
            <select id="posicionFiltro" class="form-select">
                <option value="">Todas</option>
                <option value="Portero">Portero</option>
                <option value="Defensa">Defensa</option>
                <option value="Mediocampista">Mediocampista</option>
                <option value="Delantero">Delantero</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="buscadorNombre" class="form-label" style="color: white;">Buscar por nombre:</label>
            <input type="text" id="buscadorNombre" class="form-control" placeholder="Escribe el nombre del jugador...">
        </div>
    </div>
    <div class="mb-3">
        <p id="contadores" class="text-muted" style="color: white !important;">Total de jugadores: <span id="totalJugadores">0</span> | Jugadores mostrados: <span id="jugadoresMostrados">0</span></p>
    </div>
    <div class="d-flex flex-wrap gap-3 justify-content-center" id="jugadoresLista">
        {% for equipo in equipos %}
            {% for jugador in equipo.jugador_set.all %}
             <div class="card jugador-item" 
                 data-equipo-id="{{ equipo.id }}" 
                 data-posicion="{{ jugador.get_posicion_display }}" 
                 data-nombre="{{ jugador.nombre }} {{ jugador.apellido }}"
                 style="background: rgba(10, 35, 66, 0.9); border: 1px solid #08F7FE; border-radius: 12px; padding: 16px; width: auto; min-width: 300px; max-width: 500px; display:block;">
                    <div style="position: relative;">
                        {% if jugador.verificado %}
                            <div class="badge-verificado">V</div>
                        {% endif %}
                        <div class="d-flex align-items-center">
                        {% if jugador.foto %}
                            <img src="{{ jugador.foto.url }}" alt="{{ jugador.nombre }}" 
                                 style="width:64px; height:64px; object-fit:contain; border-radius:50%; margin-right:18px; image-rendering:auto; cursor:pointer;" 
                                 onclick="expandirFoto('{{ jugador.foto.url }}', '{{ jugador.nombre }} {{ jugador.apellido }}')">
                        {% endif %}
                        <div class="flex-grow-1">
                            <strong class="text-white">{{ jugador.nombre }} {{ jugador.apellido }}</strong><br>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="text-white">#{{ jugador.numero_camiseta }} | {{ jugador.get_posicion_display }} | {{ jugador.fecha_nacimiento|calcular_edad }} años |</span>
                                <b>
                                    {% if equipo.logo %}
                                        <div style="display: inline-block; text-align: center; width: fit-content;">
                                            <img src="{{ equipo.logo.url }}" alt="{{ equipo.nombre }}" style="height:42px; display:block; margin:0 auto 2px auto; object-fit:contain; image-rendering:auto;">
                                            <span style="display:block; line-height:1; font-size:0.85em; white-space: nowrap; color: white;">{{ equipo.nombre }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-white">{{ equipo.nombre }}</span>
                                    {% endif %}
                                </b>
                            </div>
                        </div>
                    </div>
                    </div>
                    <div style="margin-top: 12px; text-align: right;">
                        <span style="color: #08F7FE; font-size: 0.95em;">Fecha de registro: {{ jugador.fecha_creacion|date:'d/m/Y H:i' }}</span><br>
                       
                        <a href="{% url 'jugador_detalle' jugador.id %}" class="btn btn-outline-info btn-sm ms-2" title="Ver detalles">
                            <i class="fas fa-eye"></i> Detalles
                        </a>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    <div class="w-100 d-flex justify-content-center mt-4" id="paginacionJugadores" style="display: block; min-height: 50px;"></div>
        <style>
        /* Badge verificado: positioned toward the outer corner so it doesn't overlap team logo */
        .badge-verificado {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(0,0,0,0.4);
            z-index: 10;
            border: 2px solid rgba(255,255,255,0.06);
        }

        @media (max-width: 600px) {
            .badge-verificado { width:24px; height:24px; top: -6px; right: -6px; font-size:0.9em; }
        }

        #paginacionJugadores {
            flex-wrap: wrap;
            gap: 0.5rem;
            max-width: 100vw;
            overflow-x: auto;
        }
        #paginacionJugadores button {
            min-width: 40px;
            min-height: 40px;
            font-size: 1.1em;
            border-radius: 8px;
            margin-bottom: 6px;
        }
        @media (max-width: 600px) {
            #paginacionJugadores button {
                min-width: 48px;
                min-height: 48px;
                font-size: 1.2em;
            }
        }
        </style>
    </div>

    <!-- Modal para expandir foto -->
    <div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="background: linear-gradient(135deg, #0a2342 0%, #1a365d 100%); border: 2px solid #08F7FE;">
                <div class="modal-header border-bottom" style="border-color: #08F7FE !important;">
                    <h5 class="modal-title text-white" id="fotoModalLabel">Foto del Jugador</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="fotoExpandida" src="" alt="" class="img-fluid rounded" style="max-height: 70vh; object-fit: contain;">
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let paginaActual = 1;
    const porPagina = 12;

    function expandirFoto(urlFoto, nombreJugador) {
        document.getElementById('fotoExpandida').src = urlFoto;
        document.getElementById('fotoExpandida').alt = nombreJugador;
        document.getElementById('fotoModalLabel').textContent = nombreJugador;
        var modal = new bootstrap.Modal(document.getElementById('fotoModal'));
        modal.show();
    }

    function mostrarPaginaJugadores(pagina) {
        var allItems = Array.from(document.querySelectorAll('.jugador-item'));
        var visibles = allItems.filter(item => item.classList.contains('filtrado'));
        var total = visibles.length;
        var totalPaginas = Math.max(1, Math.ceil(total / porPagina));
        pagina = Math.max(1, Math.min(pagina, totalPaginas));
        paginaActual = pagina;

        // Ocultar todos
        allItems.forEach(function(item) {
            item.style.display = 'none';
        });

        // Mostrar solo los de la página actual
        visibles.forEach(function(item, idx) {
            if (idx >= (pagina-1)*porPagina && idx < pagina*porPagina) {
                item.style.display = 'block';
            }
        });

        // Actualizar paginación
        var paginacion = document.getElementById('paginacionJugadores');
        if (paginacion) {
            paginacion.innerHTML = '';
            
            if (totalPaginas > 1) {
                let pagContainer = document.createElement('div');
                pagContainer.style.display = 'flex';
                pagContainer.style.flexWrap = 'wrap';
                pagContainer.style.justifyContent = 'center';
                pagContainer.style.gap = '0.5rem';
                pagContainer.style.width = '100%';
                
                for (let i = 1; i <= totalPaginas; i++) {
                    let btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'btn btn-lg ' + (i === pagina ? 'btn-primary' : 'btn-outline-primary');
                    btn.style.minWidth = '40px';
                    btn.style.minHeight = '40px';
                    btn.style.fontSize = '1.1em';
                    btn.style.borderRadius = '8px';
                    btn.style.marginBottom = '6px';
                    btn.style.cursor = 'pointer';
                    btn.type = 'button';
                    btn.onclick = function() { 
                        mostrarPaginaJugadores(i); 
                        window.scrollTo({top: document.getElementById('jugadoresLista').offsetTop-60, behavior:'smooth'}); 
                    };
                    pagContainer.appendChild(btn);
                }
                paginacion.appendChild(pagContainer);
            }
        }
    }

    function filtrarJugadores() {
        var filtroEquipo = document.getElementById('equipoFiltro').value.trim();
        var filtroPosicion = document.getElementById('posicionFiltro').value.trim();
        var filtroNombre = document.getElementById('buscadorNombre').value.trim().toLowerCase();
        
        var items = document.querySelectorAll('.jugador-item');
        var totalJugadores = items.length;
        var visiblesCount = 0;

        items.forEach(function(item) {
            var equipoId = item.getAttribute('data-equipo-id') || '';
            var posicion = item.getAttribute('data-posicion') || '';
            var nombre = (item.getAttribute('data-nombre') || '').toLowerCase();

            var coincideEquipo = (filtroEquipo === '' || equipoId === filtroEquipo);
            var coincidePosicion = (filtroPosicion === '' || posicion === filtroPosicion);
            var coincideNombre = (filtroNombre === '' || nombre.includes(filtroNombre));

            if (coincideEquipo && coincidePosicion && coincideNombre) {
                item.classList.add('filtrado');
                visiblesCount++;
            } else {
                item.classList.remove('filtrado');
            }
        });

        document.getElementById('totalJugadores').textContent = totalJugadores;
        document.getElementById('jugadoresMostrados').textContent = visiblesCount;
        mostrarPaginaJugadores(1);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var items = document.querySelectorAll('.jugador-item');
        
        // Marcar todos como filtrados inicialmente
        items.forEach(function(item) {
            item.classList.add('filtrado');
        });

        // Actualizar contadores
        document.getElementById('totalJugadores').textContent = items.length;
        document.getElementById('jugadoresMostrados').textContent = items.length;
        
        // Mostrar primera página
        mostrarPaginaJugadores(1);

        // Event listeners para filtros
        var equipoFiltro = document.getElementById('equipoFiltro');
        var posicionFiltro = document.getElementById('posicionFiltro');
        var buscadorNombre = document.getElementById('buscadorNombre');

        if (equipoFiltro) {
            equipoFiltro.addEventListener('change', filtrarJugadores);
        }
        if (posicionFiltro) {
            posicionFiltro.addEventListener('change', filtrarJugadores);
        }
        if (buscadorNombre) {
            buscadorNombre.addEventListener('input', filtrarJugadores);
        }
    });
</script>
{% endblock %}