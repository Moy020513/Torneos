{% extends 'torneos/base.html' %}
{% load custom_filters %}
{% block categoria_content %}
    <!-- Encabezado/nav heredados desde torneos/base.html -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="equipoFiltro" class="form-label" style="color: white;">Filtrar por equipo:</label>
            <select id="equipoFiltro" class="form-select">
                <option value="">Todos</option>
                {% for equipo in equipos %}
                    <option value="{{ equipo.id }}">{{ equipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="posicionFiltro" class="form-label" style="color: white;">Filtrar por posición:</label>
            <select id="posicionFiltro" class="form-select">
                <option value="">Todas</option>
                <option value="Portero">Portero</option>
                <option value="Defensa">Defensa</option>
                <option value="Mediocampista">Mediocampista</option>
                <option value="Delantero">Delantero</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="buscadorNombre" class="form-label" style="color: white;">Buscar por nombre:</label>
            <input type="text" id="buscadorNombre" class="form-control" placeholder="Escribe el nombre del jugador...">
        </div>
        {% if user.is_superuser %}
        <div class="col-md-4">
            <label for="ordenJugadores" class="form-label" style="color: white;">Orden:</label>
            <select id="ordenJugadores" class="form-select">
                <option value="default">Por defecto</option>
                <option value="ultimos">Últimos agregados</option>
                <option value="antiguos">Más antiguos</option>
            </select>
        </div>
        {% endif %}
    </div>
    <div class="mb-3">
        <p id="contadores" class="text-muted" style="color: white !important;">Total de jugadores: <span id="totalJugadores">0</span> | Jugadores mostrados: <span id="jugadoresMostrados">0</span></p>
    </div>
    <div class="d-flex flex-wrap gap-3 justify-content-center" id="jugadoresLista">
        {% for equipo in equipos %}
            {% for jugador in equipo.jugador_set.all %}
             <div class="card jugador-item" 
                 data-equipo-id="{{ equipo.id }}" 
                 data-posicion="{{ jugador.get_posicion_display }}" 
                 data-nombre="{{ jugador.nombre }} {{ jugador.apellido }}"
                 data-fecha="{{ jugador.fecha_creacion|date:'c' }}"
                 data-href="{% url 'jugador_detalle' jugador.id %}">
                    <div style="position: relative;">
                        {% if jugador.verificado %}
                            <div class="badge-verificado">V</div>
                        {% endif %}
                        <div class="d-flex align-items-center">
                        {% if jugador.foto %}
                            <img src="{{ jugador.foto.url }}" alt="{{ jugador.nombre }}" 
                                 style="width:64px; height:64px; object-fit:contain; border-radius:50%; margin-right:18px; image-rendering:auto; cursor:pointer;" 
                                 onclick="expandirFoto('{{ jugador.foto.url }}', '{{ jugador.nombre }} {{ jugador.apellido }}')">
                        {% else %}
                            <div style="width:64px; height:64px; border-radius:50%; background: rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center; margin-right:18px;">
                                <!-- Icono de persona (SVG) -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#ffffff" opacity="0.95"/>
                                    <path d="M3 21c0-3.866 3.582-7 9-7s9 3.134 9 7v1H3v-1z" fill="#ffffff" opacity="0.9"/>
                                </svg>
                            </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <strong class="text-white">{{ jugador.nombre }} <br /> {{ jugador.apellido }}</strong><br>
                            {% if user.is_superuser %}
                            <small class="text-white-50">Registrado: {{ jugador.fecha_creacion|date:'d/m/Y H:i' }}</small><br>
                            {% endif %}
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <ul class="list-unstyled mb-0 text-white" style="font-size:0.95em; margin:0; padding-left:0;">
                                    <li>#{{ jugador.numero_camiseta }}</li>
                                    <li>{{ jugador.get_posicion_display }}</li>
                                    <li>{{ jugador.fecha_nacimiento|calcular_edad }} años</li>
                                </ul>
                                <b style="margin-left: auto; display:flex; align-items:center; justify-content:flex-end;">
                                    {% if equipo.logo %}
                                        <div style="display: inline-block; text-align: center; width: fit-content;">
                                            <img src="{{ equipo.logo.url }}" alt="{{ equipo.nombre }}" style="height:42px; display:block; margin:0 auto 2px auto; object-fit:contain; image-rendering:auto;">
                                           
                                        </div>
                                    {% else %}
                                        <div style="display:inline-block; text-align:center; width: fit-content;">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" role="img" aria-label="{{ equipo.nombre }} escudo"
                                                 style="height:42px; display:block; margin:0 auto 2px auto; object-fit:contain; image-rendering:auto;">
                                                <!-- Shield background -->
                                                <path d="M32 2 L10 10 v14 c0 18 12 30 22 36 10-6 22-18 22-36V10L32 2z"
                                                      fill="#999999ff"/>
                                                <!-- Shield inner highlight -->
                                                <path d="M32 6 L14 13 v10 c0 15 10 26 18 31 8-5 18-16 18-31V13L32 6z"
                                                      fill="rgba(255,255,255,0.06)"/>
                                                <!-- Soccer ball (stylized) -->
                                                <g transform="translate(18,18)" fill="#ffffff">
                                                    <circle cx="14" cy="14" r="9" fill="#ffffff" />
                                                    <path d="M14 6 L17.5 8.5 L16.5 12 L14 14 L11.5 12 L10.5 8.5 Z" fill="#0b3b6f"/>
                                                    <path d="M14 22 L17.5 19.5 L16.5 16 L14 14 L11.5 16 L10.5 19.5 Z" fill="#0b3b6f"/>
                                                    <path d="M6 14 L8.5 17.5 L11 16 L11.5 14 L11 12 L8.5 10.5 Z" fill="#0b3b6f"/>
                                                    <path d="M22 14 L19.5 17.5 L17 16 L16.5 14 L17 12 L19.5 10.5 Z" fill="#0b3b6f"/>
                                                    <path d="M10.5 8.5 L13 6 L15.5 8.5 L14 10.5 L11.5 8.5 Z" fill="rgba(11,59,111,0.8)"/>
                                                </g>
                                            </svg>
                                        </div>
                                    {% endif %}
                                </b>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    <div class="w-100 d-flex justify-content-center mt-4" id="paginacionJugadores" style="display: block; min-height: 50px;"></div>
    
        <style>
        /* Jugador card visual styles (professional look) */
        .jugador-item {
            background:
            repeating-linear-gradient(50deg,
                rgba(155,255,255,0.04) 0 2px,
                rgba(0, 119, 255, 0.47) 9px 10px
            ),
            linear-gradient(180deg, rgba(0, 41, 80, 0.69) 0%, rgba(6, 24, 46, 1) 100%);
            background-blend-mode: overlay;
            border: 2px solid rgba(255, 255, 255, 1);
            border-radius: 12px;
            padding: 16px;
            width: auto;
            min-width: 300px;
            max-width: 500px;
            display: block;
            box-shadow: 0 6px 9px rgba(0, 195, 255, 1);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            cursor: pointer;
        }

        .jugador-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(2,12,34,0.55);
        }

        /* Badge verificado: positioned toward the outer corner so it doesn't overlap team logo */
        .badge-verificado {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(0,0,0,0.4);
            z-index: 10;
            border: 2px solid rgba(255,255,255,0.06);
        }

        @media (max-width: 600px) {
            .badge-verificado { width:24px; height:24px; top: -6px; right: -6px; font-size:0.9em; }
            /* Make jugador cards consistent width on small screens */
            .jugador-item {
                flex: 0 0 calc(100% - 32px) !important;
                max-width: calc(100% - 32px) !important;
                min-width: 0 !important;
            }
        }

        #paginacionJugadores {
            flex-wrap: wrap;
            gap: 0.5rem;
            max-width: 100vw;
            overflow-x: auto;
        }
        #paginacionJugadores button {
            min-width: 40px;
            min-height: 40px;
            font-size: 1.1em;
            border-radius: 8px;
            margin-bottom: 6px;
        }
        @media (max-width: 600px) {
            #paginacionJugadores button {
                min-width: 48px;
                min-height: 48px;
                font-size: 1.2em;
            }
        }
        </style>
    </div>

    <!-- Modal para expandir foto -->
    <div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="background: linear-gradient(135deg, #0a2342 0%, #1a365d 100%); border: 2px solid #08F7FE;">
                <div class="modal-header border-bottom" style="border-color: #08F7FE !important;">
                    <h5 class="modal-title text-white" id="fotoModalLabel">Foto del Jugador</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="fotoExpandida" src="" alt="" class="img-fluid rounded" style="max-height: 70vh; object-fit: contain;">
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let paginaActual = 1;
    const porPagina = 12;

    function expandirFoto(urlFoto, nombreJugador) {
        document.getElementById('fotoExpandida').src = urlFoto;
        document.getElementById('fotoExpandida').alt = nombreJugador;
        document.getElementById('fotoModalLabel').textContent = nombreJugador;
        var modal = new bootstrap.Modal(document.getElementById('fotoModal'));
        modal.show();
    }

    function mostrarPaginaJugadores(pagina) {
        var allItems = Array.from(document.querySelectorAll('.jugador-item'));
        var visibles = allItems.filter(item => item.classList.contains('filtrado'));
        var total = visibles.length;
        var totalPaginas = Math.max(1, Math.ceil(total / porPagina));
        pagina = Math.max(1, Math.min(pagina, totalPaginas));
        paginaActual = pagina;

        // Ocultar todos
        allItems.forEach(function(item) {
            item.style.display = 'none';
        });

        // Mostrar solo los de la página actual
        visibles.forEach(function(item, idx) {
            if (idx >= (pagina-1)*porPagina && idx < pagina*porPagina) {
                item.style.display = 'block';
            }
        });

        // Actualizar paginación
        var paginacion = document.getElementById('paginacionJugadores');
        if (paginacion) {
            paginacion.innerHTML = '';
            
            if (totalPaginas > 1) {
                let pagContainer = document.createElement('div');
                pagContainer.style.display = 'flex';
                pagContainer.style.flexWrap = 'wrap';
                pagContainer.style.justifyContent = 'center';
                pagContainer.style.gap = '0.5rem';
                pagContainer.style.width = '100%';
                
                for (let i = 1; i <= totalPaginas; i++) {
                    let btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'btn btn-lg ' + (i === pagina ? 'btn-primary' : 'btn-outline-primary');
                    btn.style.minWidth = '40px';
                    btn.style.minHeight = '40px';
                    btn.style.fontSize = '1.1em';
                    btn.style.borderRadius = '8px';
                    btn.style.marginBottom = '6px';
                    btn.style.cursor = 'pointer';
                    btn.type = 'button';
                    btn.onclick = function() { 
                        mostrarPaginaJugadores(i); 
                        window.scrollTo({top: document.getElementById('jugadoresLista').offsetTop-60, behavior:'smooth'}); 
                    };
                    pagContainer.appendChild(btn);
                }
                paginacion.appendChild(pagContainer);
            }
        }
    }

    // Reordena las tarjetas según el select de admin
    function sortJugadores(order) {
        const container = document.getElementById('jugadoresLista');
        if (!container) return;
        const items = Array.from(container.querySelectorAll('.jugador-item'));
        if (order === 'default') {
            // opcional: devolver al orden DOM original (por equipo) — aquí simplemente no hacemos nada
            // para mantener la consistencia, podríamos reload = true; pero dejamos el orden actual
        } else {
            items.sort((a, b) => {
                const fa = a.getAttribute('data-fecha') || '';
                const fb = b.getAttribute('data-fecha') || '';
                if (!fa || !fb) return 0;
                const da = new Date(fa);
                const db = new Date(fb);
                if (order === 'ultimos') return db - da; // descendente
                if (order === 'antiguos') return da - db; // ascendente
                return 0;
            });
            // Re-append en el nuevo orden
            items.forEach(item => container.appendChild(item));
        }
        // después de reordenar, recalcula filtrado y paginación
        filtrarJugadores();
    }

    // Event listener para el select admin
    document.addEventListener('DOMContentLoaded', function() {
        const ordenSelect = document.getElementById('ordenJugadores');
        if (ordenSelect) {
            ordenSelect.addEventListener('change', function(e) {
                sortJugadores(e.target.value);
            });
        }
    });

    function filtrarJugadores() {
        var filtroEquipo = document.getElementById('equipoFiltro').value.trim();
        var filtroPosicion = document.getElementById('posicionFiltro').value.trim();
        var filtroNombre = document.getElementById('buscadorNombre').value.trim().toLowerCase();
        
        var items = document.querySelectorAll('.jugador-item');
        var totalJugadores = items.length;
        var visiblesCount = 0;

        items.forEach(function(item) {
            var equipoId = item.getAttribute('data-equipo-id') || '';
            var posicion = item.getAttribute('data-posicion') || '';
            var nombre = (item.getAttribute('data-nombre') || '').toLowerCase();

            var coincideEquipo = (filtroEquipo === '' || equipoId === filtroEquipo);
            var coincidePosicion = (filtroPosicion === '' || posicion === filtroPosicion);
            var coincideNombre = (filtroNombre === '' || nombre.includes(filtroNombre));

            if (coincideEquipo && coincidePosicion && coincideNombre) {
                item.classList.add('filtrado');
                visiblesCount++;
            } else {
                item.classList.remove('filtrado');
            }
        });

        document.getElementById('totalJugadores').textContent = totalJugadores;
        document.getElementById('jugadoresMostrados').textContent = visiblesCount;
        mostrarPaginaJugadores(1);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var items = document.querySelectorAll('.jugador-item');
        
        // Marcar todos como filtrados inicialmente
        items.forEach(function(item) {
            item.classList.add('filtrado');
        });

        // Actualizar contadores
        document.getElementById('totalJugadores').textContent = items.length;
        document.getElementById('jugadoresMostrados').textContent = items.length;
        
        // Mostrar primera página
        mostrarPaginaJugadores(1);

        // Event listeners para filtros
        var equipoFiltro = document.getElementById('equipoFiltro');
        var posicionFiltro = document.getElementById('posicionFiltro');
        var buscadorNombre = document.getElementById('buscadorNombre');

        if (equipoFiltro) {
            equipoFiltro.addEventListener('change', filtrarJugadores);
        }
        if (posicionFiltro) {
            posicionFiltro.addEventListener('change', filtrarJugadores);
        }
        if (buscadorNombre) {
            buscadorNombre.addEventListener('input', filtrarJugadores);
        }

        // Hacer que toda la card del jugador sea clicable (salta a detalle), excepto al clicar la foto
        var cards = document.querySelectorAll('.jugador-item');
        cards.forEach(function(card) {
            var href = card.getAttribute('data-href');
            if (!href) return;
            // add click handler
            card.addEventListener('click', function(e) {
                // si el click fue sobre la imagen (que abre el modal) o sobre un enlace/btn, no navegar
                if (e.target.closest('img') || e.target.closest('a') || e.target.closest('button')) return;
                window.location.href = href;
            });
        });
    });
</script>
{% endblock %}